<!DOCTYPE html>
<html>
<head>
<script>
var canvas, ctx;
var asteroidVertices = [];
var asteroids = [];
var spaceshipVertices = [];
var spaceship;
var bullets = [];
var bulletVertices = [];
var bulletReady = true;
var aliens = [];
var aliensAlive = false;

var level;
var lives;
var score = 0;
var playerVulnerable = true;
var secondsTillAlien;
const alienCountdownInterval = setInterval(countdownAlienTimer, 1000);
var alienTimerColour = true;

var tempAsteroid;

var gameLoopRunning;

function init() {
	canvas = document.getElementById("canvas");
	ctx = canvas.getContext("2d");	

	asteroidVertices.push({x:-1, y:2});
	asteroidVertices.push({x:3, y:1});
	asteroidVertices.push({x:4, y:-2});
	asteroidVertices.push({x:0, y:-3});
	asteroidVertices.push({x:-3, y:-2});

	spaceshipVertices.push({x:0, y:2});
	spaceshipVertices.push({x:1, y:0});
	spaceshipVertices.push({x:0, y:-1});
	spaceshipVertices.push({x:-1, y:0});

  bulletVertices.push({x:0, y:0});
  bulletVertices.push({x:0, y:1});

	setKeyHandlers();

  level = 1;
  lives = 3;
  startLevel();
	gameLoop();
}

function setKeyHandlers() {
	document.onkeydown = function(event) {
		var code = (event.keyCode || event.charCode);
		if (code==37) // left arrow
			spaceship.drot = -0.2;
		else if (code==39) // right arrow
			spaceship.drot = 0.2;
		else if (code==38) // up arrow
			spaceship.thrust = true;
    else if (code==32 && bulletReady){ // spacebar
      bulletReady = false;
			shootBullet();
      window.setTimeout(() => {bulletReady=true;}, 150); //bullet cooldown in millis.
    }
	};

	document.onkeyup = function(event) {
		var code = (event.keyCode || event.charCode);
		if (code==37 || code==39)
			spaceship.drot = 0;
		else if (code==38)
			spaceship.thrust = false;
	};
}

function spawnAsteroids() {
	for (var i=0; i<1; i++) {
		// var a = {
    //   x:Math.random()*600,
    //   y:Math.random()*600,
    //   rot:Math.random()*2*Math.PI, 
    //   scale:5+Math.random()*15, 
    //   dx:(Math.random()-0.5)*10,
    //   dy:(Math.random()-0.5)*10,
    //   drot:(Math.random()-0.5)*0.2,
    //   vertices:asteroidVertices,
    //   parent:true
    // };

    //cheeky
    var a = {
      x:300,
      y:390,
      rot:0, 
      scale:13, 
      dx:0,
      dy:0,
      drot:0,
      vertices:asteroidVertices,
      parent:true
    };
    
		asteroids.push(a);
	}
}

function spawnSpaceship() {
	spaceship = {x:300, y:300, rot:0, scale:10, dx:0, dy:0, drot:0, vertices:spaceshipVertices, thrust:false};
}

function gameLoop() {
  if(gameLoopRunning){
    window.setTimeout(gameLoop, 1000/30);

    ctx.fillStyle = "rgb(190,190,190)";
    ctx.fillRect (0, 0, 600, 600);

    checkForCollisions();

    for (var i=0; i<asteroids.length; i++) {
      updateObject(asteroids[i]);	
      drawObject(asteroids[i]);
    }

    for (var i=0; i<bullets.length; i++) {
      updateObject(bullets[i]);	
      drawObject(bullets[i]);
    }

    for (var i=0; i<aliens.length; i++) {
      updateObject(aliens[i]);	
      drawObject(aliens[i]);
    }

    if (spaceship.thrust) {
      spaceship.dx -= Math.sin(spaceship.rot);
      spaceship.dy += Math.cos(spaceship.rot);
    }
    updateObject(spaceship);
    drawObject(spaceship);

    updateScore();
  }
}

function updateObject(o) {
	o.x += o.dx;
	o.y += o.dy;
	if (o.x<-20)
		o.x += 640;
	else if (o.x>620)
		o.x -= 640;
	if (o.y<-20)
		o.y += 640;
	else if (o.y>620)
		o.y -= 640;
	o.rot += o.drot;	
}

function drawObject(o) {
	var pt = getTransformedVertex(o.vertices[0], o); 
	ctx.beginPath();
	ctx.moveTo(pt.x, pt.y);

	for (var i=1; i<o.vertices.length; i++) {
		var pt2 = getTransformedVertex(o.vertices[i], o); 
		ctx.lineTo(pt2.x, pt2.y);
	}

	ctx.lineTo(pt.x, pt.y);

	ctx.stroke();	
}

function getTransformedVertex(vertex, object) {
	// rotate
	var x = vertex.x * Math.cos(object.rot) - vertex.y * Math.sin(object.rot);
	var y = vertex.x *  Math.sin(object.rot) + vertex.y * Math.cos(object.rot);
	// scale
	x *= object.scale;
	y *= object.scale;
	// translate
	x += object.x;
	y += object.y;

	return {x:x, y:y};
}

//BEING MY CODE::

function shootBullet() {
  var spaceShipTip = getTransformedVertex(spaceship.vertices[0], spaceship)
  sinSpaceShipRotation = Math.sin(spaceship.rot);
  cosSpaceShipRotation = Math.cos(spaceship.rot);
  bullet = {
    x:spaceShipTip.x+sinSpaceShipRotation*-0.1, //start bullet slightly in front of ship to avoid collision.
    y:spaceShipTip.y+cosSpaceShipRotation*0.1, 
    rot:spaceship.rot,
    scale:10,
    dx:sinSpaceShipRotation*-3+spaceship.dx*.75, 
    dy:cosSpaceShipRotation*3+spaceship.dy*.75,
    drot:0, 
    vertices:bulletVertices
  };
  bullets.push(bullet);
}

function checkForCollisions(){
  //bullet hit spaceship?
  for(var bulIndex = 0; bulIndex < bullets.length; bulIndex++) {
    if(isCollision(bullets[bulIndex], spaceship)){
      deleteBullet(bulIndex);
      playerHit()
    }
  }
  //spaceship inside asteroid?
  for(var astIndex = 0; astIndex < asteroids.length; astIndex++) {
    tempAsteroid = asteroids[astIndex];
    if(isCollision(spaceship, tempAsteroid)){
      playerHit();
    }
    //are any bullets inside asteroid?
    for(var bulIndex = 0; bulIndex < bullets.length; bulIndex++) {
      if(isCollision(bullets[bulIndex], tempAsteroid)){
        deleteBullet(bulIndex);
        deleteAsteroid(astIndex);
        if(tempAsteroid.parent) {
          score += 10; //10 for parent
          spawnFourAsteroids(tempAsteroid.x, tempAsteroid.y);
        }else{
          score += 5; //5 for baby
        }
      }
    }
  }
}

//using point-inside-polygon collision detection
//if points is the right of all line segments because all asteroids are convex.
//it is possible that the corner of an asteroid is colliding with the side of a spaceship between the corners. But that bug will maybe be only for a frame or two.

//we will be checking each vertex of the spaceship against the sides of the asteroids.
//This method
function isCollision(obj1, obj2){
  var isCollisionBool;

  for(var obj1VertIndex = 0; obj1VertIndex < obj1.vertices.length; obj1VertIndex++){
    var globalObj1Vert = getTransformedVertex(obj1.vertices[obj1VertIndex], obj1);
    isCollisionBool = true;

    for(var astVertIndex = 0; astVertIndex < obj2.vertices.length; astVertIndex++){
      //get global obj2 coordinates
      var globalObj2Vert1 = getTransformedVertex(obj2.vertices[astVertIndex], obj2);
      
      if(astVertIndex==obj2.vertices.length-1){
        var globalObj2Vert2 = getTransformedVertex(obj2.vertices[0], obj2);
      }else{
        var globalObj2Vert2 = getTransformedVertex(obj2.vertices[astVertIndex+1], obj2);
      }
      var pointCompToLine = ((globalObj1Vert.y - globalObj2Vert1.y)*(globalObj2Vert2.x - globalObj2Vert1.x))-((globalObj1Vert.x - globalObj2Vert1.x)*(globalObj2Vert2.y - globalObj2Vert1.y));
      //if it is greater than 0 it is on the left.
      if((pointCompToLine>0)){
        isCollisionBool = false;
      }
    }
    if(isCollisionBool){
      return true;
    }
  }
  return false;
}



function spawnFourAsteroids(parentX, parentY) {
  //defining positive and negatives dx and dy to send an asteroid into each quadrant.
  dxSign = [1, -1, -1, 1];
  dySign = [1, 1, -1, -1];
  for(var index = 0; index < dxSign.length; index++) {
    var newDx = (Math.random())*3*dxSign[index];
    var newDy = (Math.random())*3*dxSign[index];
    var a = {
      rot:Math.random()*2*Math.PI,
      scale:5+Math.random()*3, 
      dx:newDx,
      dy:newDy,
      drot:(Math.random()-0.5)*0.2,
      vertices:asteroidVertices,
      parent:false,
      x:parentX+newDx,
      y:parentY+newDy
    }
    asteroids.push(a);
  }
}

function deleteAsteroid(index){
  asteroids.splice(index, 1);
}

function deleteBullet(index){
  bullets.splice(index, 1);
}

function startLevel(){
  spawnAsteroids(level);
	spawnSpaceship();
  secondsTillAlien = 120; //2 minutes to complete level.
  gameLoopRunning = true;
}

function reset(){
  aliensAlive = false;
  spaceship = undefined;
  asteroids.length = 0;
  bullets.length = 0;
  
  lives = 3;
  //reset lives
  for(var i = 1; i <= 3; i++) {
    document.getElementById("life"+i).innerHTML = "❤️";
  }

  //reset level
  level = 1;
  document.getElementById("level").innerHTML = "1";

  //reset score
  score = 0;
  updateScore();
}

function levelComplete(){
  level += 1;
  lives = 3;
  reset();
  startLevel();
}

function playerHit(){
  if(playerVulnerable){
    playerVulnerable = false;
    window.setTimeout(() => {playerVulnerable=true;}, 1500);
    document.getElementById("life"+lives).innerHTML = "";
    lives -= 1;
    if(lives == 0){
      playerDeath();
    }
  }
}

function playerDeath(){
  gameLoopRunning = false;
  //play exposion animation
  //delay things for 3 seconds.
  reset();
  startLevel();
}

function updateScore(){
  document.getElementById("score").innerHTML = score;
}


function spawnAliens(){
  aliensAlive = true;
  console.log("Spawning aliens...!!!!!!!");
}

function countdownAlienTimer(){
  if(gameLoopRunning && !aliensAlive){
    secondsTillAlien--;
    if(secondsTillAlien == 0){
      spawnAliens();
    }
    var alienCountdownText = document.getElementById("alienCountdown");
    alienCountdownText.innerHTML = secondsTillAlien;
    if(alienTimerColour){
      alienCountdownText.style.color = "black";
    }else{
      alienCountdownText.style.color = "red";
    }
    alienTimerColour = !alienTimerColour;
  }
}

</script>

<style>
  .textbox{
    display: block;
    width: 590px;
  }
  .left{
    float: left;
  }
  .middle{
    float: middle;
  }
  .right{
    float: right;
  }
</style>
</head>

<body onload="init();">

<center>
<br>
<div class="textbox">
  <span class="left">
    Level : <span id="level">1</span>
  </span>
  <span class="middle">
    Score : <span id="score">0</span>
  </span>
  <span class="right">  
    Lives : <span id="life1">❤️</span><span id="life2">❤️</span><span id="life3">❤️</span>
  </span>
</div>

<canvas id="canvas" width="600" height="600"></canvas>

<div class="textbox">
  <span class="middle">
    <span id="alienCountdown"></span>
  </span>
</div>

</body>
</html>